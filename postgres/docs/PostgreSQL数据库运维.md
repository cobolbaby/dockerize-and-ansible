# PostgreSQL数据库运维

[TOC]

## 大纲

### 目标，受众，结果

运维 + 架构师，目标是了解当前数据库的架构以及瓶颈点，哪些能做哪些不能做，如何瘦身

## 数据库运维 

### 从服务部署架构看系统瓶颈

https://www.processon.com/view/link/6577e0761cc724576a445636

Inventec PostgreSQL HA 主备集群不仅仅提供开源 PostgreSQL 的核心功能，还提供高可用、读写分离，CDC，服务监控等等扩展支持。所以当我们说到 PostgreSQL 服务的时候，已经不单单只是指 PostgreSQL 数据库软件本身了。

相关组件说明:

| 组件名称 | 组件说明 |
| ---------- | ----------- |
| PostgreSQL | 数据库核心组件 |
| Patroni + Etcd | 支持集群状态管理，如主从角色切换 |
| Keepalived | 维护数据库 VIP 与主机的绑定关系 |
| PgBouncer | 支持数据库服务端连接池，后期考虑切换为 pgcat |
| Pgpool | 支持读写分离，后期考虑切换为 pgcat |
| Dkron | Infra 团队提供的分布式定时任务管理服务，管理数据库自动化运维的一些任务，如备份，巡检，数据归档等 |
| Minio | 基于 S3 协议的存储服务，目前保存了数据库备份，数据库巡检报告 
| Debezium + Kafka | 支持将 PG CDC 变更同步到 Kafka，方便下游业务订阅相关变更 |
| Prometheus + Grafana | 支持数据库服务监控告警 |
| 第三方扩展插件 | 支持数据库运维，应用开发等需求，插件目前正在不断扩展中 |

#### 性能模型

[十位数据库专家：如何透过性能优化看系统架构的合理性](https://www.talkwithtrend.com/Article/196957)


### 数据库如何瘦身，轻装简行

数据量持续不断增长之后，不得不面临两个问题:

* 性能角度: 之前不慢的 SQL 开始变慢，本质上是说内存无法承载数据库的热数据，磁盘 IO 不断飙升，CPU 持续维持高位
* 管理角度: 需要满足数据快速备份，快速恢复等等需求

数据库容量治理，避免到达瓶颈:
1. 慢查询优化等等，但随着承载业务的增多，不是说优化一两个 SQL 就能让数据库的性能维持在一个健康的水平，往往需要优化 5~10 个重点 SQL，而且越往后需要关注点会越多
2. 冷热数据分离，数据归档。因为数据库归档，以及数据库分库分表都会引入跨库相关的问题，客户端在访问的时候就会有一定的限制，而且也面临着不同程度上的改造，管理的负担其实也加重了。
3. 清理废弃数据表，不过需要依赖数据血缘，以及一些监控指标做支撑


### 数据库如何做横向纵向扩展


https://www.processon.com/view/link/65d818349cc5b92aee238447

数据库的可扩展性，将上限提高
* 垂直扩展
    * 硬件层级的提升，配合数据库参数的调优，效果立杆间影
    * 但总有达到上限的一天，如果要升级硬件，硬件采购需要成本，且申请过程较为漫长
* 水平扩展
    * 主备集群: 主从同步 + 读写分离。讀寫分離方案更加讓用戶無關。
    * 分片集群: 关系型数据库的分库分表，NoSQL 数据库的哈希分片
    * 垂直分库: 按照业务拆分数据库，微服务化

#### 数据库大版本升级

**关键词:**

PG 版本升级

**典型场景:**

- 逻辑复制增强
- 并行特性增强
- 备份完整性校验
- ...

**核心知识:**

PG 12.x 版本将于 November 14, 2024 之后不再更新维护，考虑到 PG 的开源属性，选择版本的时候最好选择最新的稳定版本，所以目前来看，PG 16.x 应该是最佳选择。

**参考链接:**

- [Feature Matrix](https://www.postgresql.org/about/featurematrix/) 官方出品的功能矩阵，由于比对 PG 主要版本之间的差异
- [快速掌握 PostgreSQL 版本新特性]() 讲述 PG 10.x 到 16.x，7 个大版本的核心增强特性，中文社区出品


### 数据库的可观测性

補充一張架構圖


#### 数据库插件

| 插件名称 | 插件分类 | 插件说明 | 相关文档 |
| ---------- |  ----------- | ----------- | ----------- |
| pg_stat_statements | 运维 | SQL 统计 | 
| auto_explain | 运维 | 慢 SQL 执行计划输出 |
| pgbadger | 运维 | PG 日志分析工具 |
| pg_repack | 运维 | 在线 VACUUM FULL / REINDEX，不鎖表，要求表必須包含主鍵或唯一索引 |

